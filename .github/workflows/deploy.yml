# 이 하나의 파일이 워크플로우라고 불림 - 깃허브 액션에서 정한 하나의 단위
name: CI/CD 배포 자동화 # 워크플로우의 이름을 붙이는 것

on:
  pull_request:
    types:
      - closed

jobs:
  Deploy:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Build
        uses: appleboy/ssh-action@v1.0.3 # 사용할 라이브러리 명시

        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PASSWORD }}

          script: |
            cd ~/CI-CD-practice
            sudo git pull origin main
            ./gradlew clean build
            sudo fuser -k -n tcp 8080 || true
            nohup java -jar build/libs/*SNAPSHOT.jar > ./output.log 2>&1 &